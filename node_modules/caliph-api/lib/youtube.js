const ytdl=require("ytdl-core"),yts=require("yt-search"),axios=require("axios"),link=require("./tools/shortlink");function bytesToSize(e){return new Promise(((t,i)=>{const a=["Bytes","KB","MB","GB","TB"];if(0===e)return"n/a";const l=parseInt(Math.floor(Math.log(e)/Math.log(1024)),10);0===l&&t(`${e} ${a[l]}`),t(`${(e/1024**l).toFixed(1)} ${a[l]}`)}))}function ytMp4(e){return new Promise((async(t,i)=>{ytdl.getInfo(e).then((async e=>{let i=[];for(let t=0;t<e.formats.length;t++){let a=e.formats[t];if("mp4"==a.container&&1==a.hasVideo&&1==a.hasAudio){let{qualityLabel:e,contentLength:l,approxDurationMs:o}=a,r=await bytesToSize(l);i[t]={video:a.url,quality:e,size:r,duration:formated(parseInt(o))}}}let a=i.filter((e=>null!=e.video&&null!=e.size&&null!=e.quality)),l=(await link(a[0].video)).result.url,o=e.videoDetails.title,r=e.videoDetails.description,n=parseInt(e.videoDetails.viewCount||0),s=e.videoDetails.likes,u=e.videoDetails.dislikes,d=e.videoDetails.ownerChannelName,c=e.videoDetails.uploadDate,y=e.player_response.microformat.playerMicroformatRenderer.thumbnail.thumbnails[0].url;t({creator:"Caliph",result:{title:o,result:l,quality:a[0].quality,size:a[0].size,duration:a[0].duration,thumb:y,views:n,likes:s,dislike:u,channel:d,uploadDate:c,desc:r}})})).catch(i)}))}function ytMp3(e){return new Promise(((t,i)=>{ytdl.getInfo(e).then((async e=>{let i=[];for(let t=0;t<e.formats.length;t++){let a=e.formats[t];if('audio/webm; codecs="opus"'==a.mimeType){let{contentLength:e,approxDurationMs:l}=a,o=await bytesToSize(e);i[t]={audio:a.url,size:o,duration:formated(parseInt(l))}}}let a=i.filter((e=>null!=e.audio&&null!=e.size)),l=(await link(a[0].audio)).result.url,o=e.videoDetails.title,r=e.videoDetails.description,n=parseInt(e.videoDetails.viewCount||0),s=e.videoDetails.likes,u=e.videoDetails.dislikes,d=e.videoDetails.ownerChannelName,c=e.videoDetails.uploadDate,y=e.player_response.microformat.playerMicroformatRenderer.thumbnail.thumbnails[0].url;t({creator:"Caliph",result:{title:o,result:l,size:a[0].size,duration:a[0].duration,thumb:y,views:n,likes:s,dislike:u,channel:d,uploadDate:c,desc:r}})})).catch(i)}))}function ytPlay(e){return new Promise(((t,i)=>{yts(e).then((async e=>{let i=e.videos.slice(0,5),a=[];for(let e=0;e<i.length;e++)a.push(i[e].url);let l=a[0],o=await ytMp3(l);t(o)})).catch(i)}))}function ytPlayVid(e){return new Promise(((t,i)=>{yts(e).then((async e=>{let i=e.videos.slice(0,5),a=[];for(let e=0;e<i.length;e++)a.push(i[e].url);let l=a[0],o=await ytMp4(l);t(o)})).catch(i)}))}function formated(e){return[isNaN(e)?"--":Math.floor(e/36e5),isNaN(e)?"--":Math.floor(e/6e4)%60,isNaN(e)?"--":Math.floor(e/1e3)%60].map((e=>e.toString().padStart(2,0))).join(":")}module.exports={mp4:ytMp4.bind(),mp3:ytMp3.bind(),play:ytPlay.bind(),playvid:ytPlayVid.bind()};